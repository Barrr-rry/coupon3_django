{% load staticfiles %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="{% static 'stylesheets/L.Icon.Pulse.css' %}">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"/>
  <link href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"></link>
  <link href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"></link>
</head>
<body>
<div id="map" class="map" style="height: 370px;width: 370px"></div>
</body>
<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
<script type="text/javascript" src="{% static 'javascript/jquery.min.js' %}"></script>
<script type="text/javascript" src="{% static 'javascript/L.Icon.Pulse.js' %}"></script>
<script>
  const showError = (error) => {
    console.log('error:', error)
    const position = {
      coords: {
        latitude: '23.8523405',
        longitude: '120.9009427'
      },
      zoom: 7
    }
    switch (error.code) {
      case error.PERMISSION_DENIED:
        alert('讀取不到您目前的位置 PERMISSION_DENIED')
        showPosition(position)
        break
      case error.POSITION_UNAVAILABLE:
        alert('讀取不到您目前的位置 POSITION_UNAVAILABLE')
        showPosition(position)
        break
      case error.TIMEOUT:
        alert('讀取位置逾時')
        showPosition(position)
        break
      case error.UNKNOWN_ERROR:
        alert('Error')
        showPosition(position)
        break
    }
  }
  const showPosition = (position) => {
    const map = L.map('map').setView([position.coords.latitude, position.coords.longitude], position.zoom || 17)

    let popup = L.popup()

    function onMapClick(e) {
      popup
        .setLatLng(e.latlng)
        .setContent("經緯度座標：" + e.latlng.toString())
        .openOn(map);
    }

    map.on('click', onMapClick)

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map)

    // 創建icon圖標
    const greenIcon = new L.Icon({
      iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    })
    const orangeIcon = new L.Icon({
      iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    })
    const greyIcon = new L.Icon({
      iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    })
    const blueMarker = L.icon.pulse({iconSize: [20, 20], color: '#2e72f0', fillColor: '#2e72f0'})

    // 設定所在位置的icon
    const selfPos = L.marker([position.coords.latitude, position.coords.longitude], {icon: blueMarker}).bindPopup('目前位置')
    map.addLayer(selfPos)

    // 使用 MarkerClusterGroup 將各個地點群組化
    const markers = new L.MarkerClusterGroup()

  }


  $(document).ready(() => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(showPosition, showError)
    } else {
      alert('您的瀏覽器不支援定位系統')
      const position = {
        coords: {
          latitude: '23.8523405',
          longitude: '120.9009427'
        },
        zoom: 7
      }
      showPosition(position)
    }
  })
</script>
</html>
